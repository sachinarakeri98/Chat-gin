<script>
  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get("user") || "Anonymous";

  // Always use secure WebSocket if you're on HTTPS
  const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProtocol}://${location.host}/ws`);

  ws.onmessage = function (event) {
    const msg = JSON.parse(event.data);
    const li = document.createElement("li");
    li.innerText = `${msg.username}: ${msg.message}`;
    document.getElementById("chat").appendChild(li);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  };

  function sendMessage() {
    const text = document.getElementById("message").value.trim();
    if (!text) return;
    ws.send(JSON.stringify({ username: username, message: text }));
    document.getElementById("message").value = "";
  }

  document.getElementById("message").addEventListener("keyup", function (event) {
    if (event.key === "Enter") {
      sendMessage();
    }
  });
</script>
